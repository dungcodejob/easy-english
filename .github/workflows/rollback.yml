name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version to rollback to (e.g., v1.0.5)'
        required: true
        type: string
      create_rollback_tag:
        description: 'Create a new rollback tag'
        required: false
        default: true
        type: boolean

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate tag format
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format. Expected format: v{major}.{minor}.{patch} (e.g., v1.0.5)"
            exit 1
          fi
          echo "âœ… Tag format is valid: $TAG"
      
      - name: Checkout code at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}
          fetch-depth: 0
      
      - name: Verify tag exists
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âŒ Tag $TAG does not exist"
            exit 1
          fi
          echo "âœ… Tag $TAG exists"
          
          # Show tag information
          echo "Tag details:"
          git show "$TAG" --no-patch --format="%ai - %s"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install dependencies
        working-directory: ./server
        run: npm ci
      
      - name: Build server
        working-directory: ./server
        run: npm run build
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy rollback to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd server
          echo "ðŸ”„ Rolling back to version ${{ github.event.inputs.tag }}"
          railway up --service ${{ secrets.RAILWAY_BACKEND_SERVICE_ID || 'server' }}
      
      - name: Create rollback tag
        if: ${{ github.event.inputs.create_rollback_tag == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          ORIGINAL_TAG="${{ github.event.inputs.tag }}"
          ROLLBACK_TAG="${ORIGINAL_TAG}-rollback-$(date +%Y%m%d%H%M%S)"
          
          # Create annotated tag for rollback
          git tag -a "$ROLLBACK_TAG" -m "Rollback to $ORIGINAL_TAG"
          
          # Push tag to remote
          git push origin "$ROLLBACK_TAG"
          
          echo "âœ… Created rollback tag: $ROLLBACK_TAG"
          echo "rollback_tag=$ROLLBACK_TAG" >> $GITHUB_OUTPUT
        id: rollback_tag
      
      - name: Create GitHub Release for Rollback
        if: ${{ github.event.inputs.create_rollback_tag == 'true' }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.rollback_tag.outputs.rollback_tag }}
          release_name: Rollback to ${{ github.event.inputs.tag }}
          body: |
            ## â®ï¸ Rollback Deployment
            
            This is a rollback deployment to version **${{ github.event.inputs.tag }}**
            
            - **Original Version:** ${{ github.event.inputs.tag }}
            - **Rollback Tag:** ${{ steps.rollback_tag.outputs.rollback_tag }}
            - **Rolled back at:** ${{ github.event.repository.updated_at }}
            - **Triggered by:** @${{ github.actor }}
          draft: false
          prerelease: false
      
      - name: Rollback Summary
        run: |
          echo "# â®ï¸ Rollback Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Rolled back to:** ${{ github.event.inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event.inputs.create_rollback_tag }}" == "true" ]]; then
            echo "- **Rollback tag:** ${{ steps.rollback_tag.outputs.rollback_tag }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš ï¸ Important Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Make sure to verify the deployment in Railway" >> $GITHUB_STEP_SUMMARY
          echo "- Check application logs for any issues" >> $GITHUB_STEP_SUMMARY
          echo "- Consider creating a hotfix if needed" >> $GITHUB_STEP_SUMMARY
